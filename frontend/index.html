<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Honorine Co. Employee Feedback — Submit Review</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body class="app-page">

    <nav class="navbar">
        <div class="nav-brand">
            <span class="logo-mark">H</span>
            <span class="nav-title">Honorine Co.</span>
        </div>
        <div class="nav-links">
            <a href="index.html" class="nav-link active">Submit Review</a>
            <a href="reviews.html" class="nav-link">Reviews</a>
            <span id="adminLink" class="hidden"><a href="admin.html" class="nav-link">Admin</a></span>
        </div>
        <div class="nav-user">
            <span class="user-badge" id="userBadge">—</span>
            <button class="btn-ghost" onclick="handleLogout()">Sign Out</button>
        </div>
    </nav>

    <main class="main-content">
        <div class="page-header">
            <p class="page-eyebrow">Honorine Co. — HR Portal</p>
            <h1 class="page-title">Submit Employee Review</h1>
            <p class="page-desc">Fill in the form below and click Submit Review. Our AI will automatically analyze the sentiment of your feedback.</p>
        </div>

        <div id="successBanner" class="success-banner hidden">
            <span class="success-icon">✅</span>
            <div>
                <strong>Review submitted successfully!</strong>
                <p>The AI has analyzed the feedback. <a href="reviews.html">View all reviews →</a></p>
            </div>
        </div>

        <div class="card review-form-card">
            <form id="reviewForm">

                <div class="form-section-title">Employee Information</div>
                <div class="form-row">
                    <div class="field-group">
                        <label class="field-label">Employee First Name *</label>
                        <input type="text" id="firstName" class="field-input" placeholder="e.g. Sarah" required>
                    </div>
                    <div class="field-group">
                        <label class="field-label">Employee Last Name *</label>
                        <input type="text" id="lastName" class="field-input" placeholder="e.g. Johnson" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="field-group">
                        <label class="field-label">Department *</label>
                        <select id="department" class="field-input" required>
                            <option value="">Select department</option>
                            <option>Engineering</option>
                            <option>Sales</option>
                            <option>Marketing</option>
                            <option>Human Resources</option>
                            <option>Finance</option>
                            <option>Operations</option>
                            <option>Customer Support</option>
                            <option>Other</option>
                        </select>
                    </div>
                    <div class="field-group">
                        <label class="field-label">Job Title</label>
                        <input type="text" id="jobTitle" class="field-input" placeholder="e.g. Senior Developer">
                    </div>
                </div>

                <div class="form-section-title" style="margin-top:1.5rem">Review Details</div>

                <div class="field-group">
                    <label class="field-label">Overall Performance Rating *</label>
                    <div class="star-rating" id="starRating">
                        <button type="button" class="star" data-value="1">★</button>
                        <button type="button" class="star" data-value="2">★</button>
                        <button type="button" class="star" data-value="3">★</button>
                        <button type="button" class="star" data-value="4">★</button>
                        <button type="button" class="star" data-value="5">★</button>
                    </div>
                    <span class="rating-label" id="ratingLabel">Click to rate</span>
                    <input type="hidden" id="ratingValue" value="0">
                </div>

                <div class="field-group">
                    <label class="field-label">Review Period</label>
                    <select id="reviewPeriod" class="field-input">
                        <option value="">Select period</option>
                        <option>Q1 2025</option>
                        <option>Q2 2025</option>
                        <option>Q3 2025</option>
                        <option>Q4 2025</option>
                        <option>Annual 2025</option>
                        <option>Annual 2024</option>
                    </select>
                </div>

                <div class="field-group">
                    <label class="field-label">Feedback / Review Comments *</label>
                    <textarea id="feedbackText" class="field-input field-textarea"
                        placeholder="Write your detailed feedback here. Describe the employee's performance, strengths, areas for improvement, contributions, and any other relevant observations..."
                        rows="6" required></textarea>
                    <span class="char-count" id="charCount">0 / 512 characters</span>
                </div>

                <div class="field-group">
                    <label class="field-label">Reviewed By (Your Name)</label>
                    <input type="text" id="reviewerName" class="field-input" placeholder="Your name or leave blank for anonymous">
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="clearForm()">Clear Form</button>
                    <button type="submit" class="btn-primary" id="submitBtn">
                        <span class="btn-text">Submit Review</span>
                        <span class="btn-loader hidden">Submitting●●●</span>
                    </button>
                </div>

            </form>
        </div>
    </main>

    <script src="api.js"></script>
    <script>
        let selectedRating = 0;
        const ratingLabels = ['', 'Poor', 'Below Average', 'Average', 'Good', 'Excellent'];

        (async () => {
            const me = await checkAuth();
            if (!me.authenticated) return window.location.href = 'login.html';
            document.getElementById('userBadge').textContent = me.username;
            if (me.is_admin) document.getElementById('adminLink').classList.remove('hidden');
        })();

        document.querySelectorAll('.star').forEach(star => {
            star.addEventListener('click', () => {
                selectedRating = parseInt(star.dataset.value);
                document.getElementById('ratingValue').value = selectedRating;
                document.getElementById('ratingLabel').textContent = ratingLabels[selectedRating];
                document.querySelectorAll('.star').forEach((s, i) => {
                    s.classList.toggle('active', i < selectedRating);
                });
            });
        });

        document.getElementById('feedbackText').addEventListener('input', function () {
            const count = Math.min(this.value.length, 512);
            document.getElementById('charCount').textContent = `${count} / 512 characters`;
            if (count > 450) document.getElementById('charCount').style.color = 'var(--gold)';
            else document.getElementById('charCount').style.color = '';
        });

        document.getElementById('reviewForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const feedbackText = document.getElementById('feedbackText').value.trim();

            if (selectedRating === 0) {
                alert('Please select a performance rating before submitting.');
                return;
            }

            const btn = document.getElementById('submitBtn');
            setLoading(btn, true);

            const result = await analyzeFeedback(
                feedbackText,
                `${firstName} ${lastName}`,
                document.getElementById('department').value,
                selectedRating
            );

            setLoading(btn, false);

            if (result.error) {
                alert('Error: ' + result.error);
                return;
            }

            document.getElementById('successBanner').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            clearForm();
        });

        function clearForm() {
            document.getElementById('reviewForm').reset();
            selectedRating = 0;
            document.getElementById('ratingValue').value = 0;
            document.getElementById('ratingLabel').textContent = 'Click to rate';
            document.querySelectorAll('.star').forEach(s => s.classList.remove('active'));
            document.getElementById('charCount').textContent = '0 / 512 characters';
        }

        function setLoading(btn, loading) {
            btn.querySelector('.btn-text').classList.toggle('hidden', loading);
            btn.querySelector('.btn-loader').classList.toggle('hidden', !loading);
            btn.disabled = loading;
        }

        async function handleLogout() {
            await logoutUser();
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>